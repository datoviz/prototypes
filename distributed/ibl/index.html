<!DOCTYPE html>
<html>

<head>
    <title>IBL raster plots</title>

    <!-- Raleway font -->
    <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>

    <!-- Normalize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
        integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Skeleton -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css"
        integrity="sha512-EZLkOqwILORob+p0BXZc+Vm3RgJBOe1Iq/0fiI7r/wJgzOFZMlsqTa29UEl6v6U6gsV4uIpsNZoV32YZqrCRCQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- noUIslider -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.min.js"
        integrity="sha512-T5Bneq9hePRO8JR0S/0lQ7gdW+ceLThvC80UjwkMRz+8q+4DARVZ4dqKoyENC7FcYresjfJ6ubaOgIE35irf4w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.min.css"
        integrity="sha512-qveKnGrvOChbSzAdtSs8p69eoLegyh+1hwOMbmpCViIwj7rn4oJjdmMvWOuyQlTOZgTlZA0N2PXA7iA8/2TUYA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"
        integrity="sha512-igVQ7hyQVijOUlfg3OmcTZLwYJIBXU63xL9RC12xBHNpmGJAktDnzl9Iw0J4yrSaQtDxTTVlwhY730vphoVqJQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Custom CSS styles -->
    <style>
        #left {
            padding: 20px;
            background-color: #ddd;
        }

        #left ol {
            list-style-type: none;
        }

        #left li label {
            padding-left: 10px;
            font-weight: bold;
        }

        #left ol:first-child {
            padding-bottom: 16px;
            border-bottom: 1px solid #888;
        }

        #left ol select {
            background-color: #eaeaea;
        }



        #right img {
            width: 100%;
            aspect-ratio: 8/6;
            border: 1px solid #aaa;
        }


        /* Slider */

        .noUi-target {
            margin: 0 20px 30px 10px;
        }

        .noUi-base,
        .noUi-target {
            height: 10px !important;
        }

        .noUi-handle {
            width: 24px !important;
            height: 18px !important;
        }

        .noUi-tooltip {
            font-size: 14px;
            opacity: 0.75;
            display: none;
        }

        .noUi-active .noUi-tooltip {
            display: block;
        }

        .noUi-connect {
            background-color: #666
        }

        .noUi-handle::before,
        .noUi-handle:after {
            height: 5px !important;
        }

        .noUi-handle:before {
            left: 10px !important;
        }

        .noUi-handle:after {
            left: 12px !important;
        }
    </style>

    <!-- Array class -->
    <script>
        _DTYPE_MAPPING = {
            "uint8": [Uint8Array, 1],

            "uint16": [Uint16Array, 2],
            "int16": [Int16Array, 2],

            "uint32": [Uint32Array, 4],
            "int32": [Int32Array, 4],

            "float32": [Float32Array, 4],
            "float64": [Float64Array, 8],
        };

        function tob64(buffer) {
            var binary = '';
            var bytes = new Uint8Array(buffer);
            var len = bytes.byteLength;
            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function StructArray(count, dtype) {
            this.count = count;
            this.dtype = dtype;
            this.fields = {};
            this.itemsize = 0;
            for (let i = 0; i < dtype.length; i++) {

                let name = dtype[i][0];
                let dt = dtype[i][1];
                let count = dtype[i][2];
                let size = _DTYPE_MAPPING[dt][1];

                this.fields[name] = {
                    type: dt,
                    count: count,
                    itemsize: size,
                    offset: this.itemsize
                };
                this.itemsize += count * size;
            }
            this.buffer = new ArrayBuffer(count * this.itemsize);
        };

        StructArray.prototype.set = function (idx, name, values) {
            let field = this.fields[name];
            let vt = _DTYPE_MAPPING[field.type][0];
            let view = new vt(this.buffer, this.itemsize * idx + field.offset, field.count);
            for (let i = 0; i < field.count; i++) {
                view[i] = values[i];
            }
        };

        StructArray.prototype.b64 = function () {
            return tob64(this.buffer);
        }

    </script>

    <!-- Visualization client -->
    <script>
        const DEFAULT_URI = "https://ibl.flatironinstitute.org/public/cortexlab/Subjects/KS023/2019-12-10/001/alf/probe01/";
        const COUNT = 2000000; // max number of spikes

        const SESSIONS = {

            "https://ibl.flatironinstitute.org/public/cortexlab/Subjects/KS023/2019-12-10/001/alf/probe01/": {
                "times": "spikes.times.99ed1a2d-bb18-4f86-92f3-23a15b7d9972.npy",
                "clusters": "spikes.clusters.2e3a207d-6b7a-41b3-80b9-d759a6557b55.npy",
                "depths": "spikes.depths.9cbed712-3d4e-44d4-8ec8-f915a884e667.npy"
            },

            "https://ibl.flatironinstitute.org/public/churchlandlab/Subjects/CSHL047/2020-01-20/001/alf/probe00/": {
                "times": "spikes.times.32609666-84f6-4b20-8450-afc311b3e64e.npy",
                "clusters": "spikes.clusters.a44513ba-069e-443a-bcb6-1de2a5071615.npy",
                "depths": "spikes.depths.879aedc4-227d-4234-828e-9d9f78b7323e.npy",
            },

            "https://ibl.flatironinstitute.org/public/mainenlab/Subjects/ZM_2240/2020-01-21/001/alf/probe00/": {
                "times": "spikes.times.be8c4562-f83d-45c3-ba4d-7ac9eec94b85.npy",
                "clusters": "spikes.clusters.33e2b747-8cf9-48d7-9814-69c6aa30cd59.npy",
                "depths": "spikes.depths.7ba042a8-cc40-416f-8390-12b0c8f4009f.npy",
            }
        };

        // Data payload for a given session.
        function sessionJSON(uri) {
            return {
                "uri": uri,
                "spikes": SESSIONS[uri]
            };
        }

        // Load the initial JSON.
        function loadJSON() {
            var count = COUNT;
            return {
                "version": "1.0",
                "requests": [
                    {
                        "action": "create",
                        "type": "board",
                        "id": 1,
                        "content": {
                            "width": 800,
                            "height": 600,
                            "background": [255, 255, 255]
                        }
                    },
                    {
                        "action": "create",
                        "type": "graphics",
                        "id": 2,
                        "flags": 0,
                        "content": {
                            "board": 1,
                            "type": 7
                        }
                    },


                    // MVP: 10
                    {
                        "action": "create",
                        "type": "dat",
                        "id": 10,
                        "content": {
                            "type": 5,
                            "size": 200
                        }
                    },
                    {
                        "action": "bind",
                        "type": "dat",
                        "id": 2,
                        "content": {
                            "dat": 10,
                            "slot_idx": 0,
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 10,
                        "content": {
                            "offset": 0,
                            "size": 200,
                            "data": {
                                "mode": "base64",
                                "buffer": "AACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAAAAAACAPwAAgD8AAAAAAAAAAAAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAAAAgD8AAIA/AAAAAAAAAAAAAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAA=="
                            }
                        }
                    },


                    // Viewport: 11
                    {
                        "action": "create",
                        "type": "dat",
                        "id": 11,
                        "content": {
                            "type": 5,
                            "size": 80
                        }
                    },
                    {
                        "action": "bind",
                        "type": "dat",
                        "id": 2,
                        "content": {
                            "dat": 11,
                            "slot_idx": 1,
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 11,
                        "content": {
                            "offset": 0,
                            "size": 80,
                            "data": {
                                "mode": "base64",
                                "buffer": "AAAAAAAAAAAAAEhEAAAWRAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAwAAWAIAAAAAAAAAAAAAIAMAAFgCAAAAAAAAAAAAAAAAAAAAAAAA"
                            }
                        }
                    },


                    // Params: 12
                    {
                        "action": "create",
                        "type": "dat",
                        "id": 12,
                        "content": {
                            "type": 5,
                            "size": 20
                        }
                    },
                    {
                        "action": "bind",
                        "type": "dat",
                        "id": 2,
                        "content": {
                            "dat": 12,
                            "slot_idx": 2,
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 12,
                        "content": {
                            "offset": 0,
                            "size": 20,
                            "data": {
                                "mode": "base64",
                                "buffer": getParams()
                            }
                        }
                    },


                    // Vertex buffer: 3
                    {
                        "action": "create",
                        "type": "dat",
                        "id": 3,
                        "content": {
                            "type": 2,
                            "size": 20 * count
                        }
                    },
                    {
                        "action": "set",
                        "type": "vertex",
                        "id": 2,
                        "content": {
                            "dat": 3
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 3,
                        "content": {
                            "offset": 0,
                            "data": {
                                "mode": "ibl_ephys",
                                "count": count,
                                "session": sessionJSON(DEFAULT_URI)
                            }
                        }
                    },



                    {
                        "action": "record",
                        "type": "begin",
                        "id": 1
                    },
                    {
                        "action": "record",
                        "type": "viewport",
                        "id": 1,
                        "content": {
                            "offset": [
                                0,
                                0
                            ],
                            "shape": [
                                0,
                                0
                            ]
                        }
                    },
                    {
                        "action": "record",
                        "type": "draw",
                        "id": 1,
                        "content": {
                            "graphics": 2,
                            "first_vertex": 0,
                            "vertex_count": count
                        }
                    },
                    {
                        "action": "record",
                        "type": "end",
                        "id": 1
                    }
                ]
            };
        }

        // Generate a JSON request to update to a new URI.
        function updateRequest(uri) {
            const req = {
                "version": "1.0",
                "requests": [
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 3,
                        "content": {
                            "offset": 0,
                            "data": {
                                "mode": "ibl_ephys",
                                "count": COUNT,
                                "session": sessionJSON(uri)
                            }
                        }
                    },
                ]
            };

            return req;
        }

        // Send requests to the server.
        function submit(contents) {
            if (!window.websocket) return;
            if (window.websocket.readyState != 1) return;
            window.websocket.send(JSON.stringify(contents));
        }

        // Display an array buffer.
        function show(arrbuf) {
            const blob = new Blob([arrbuf]);
            const url = URL.createObjectURL(blob);
            const img = document.getElementById('img');
            img.src = url;
        }

        function initSlider(id, range) {
            noUiSlider.create(document.getElementById(id), {
                start: range,
                connect: true,
                range: {
                    'min': range[0],
                    'max': range[1]
                },
                tooltips: true,
            });
        };

        function onSliderChange(id, callback) {
            document.getElementById(id).noUiSlider.on('update',
                function (values, handle, unencoded, tap, positions, noUiSlider) {
                    min = parseFloat(values[0]);
                    max = parseFloat(values[1]);
                    callback(min, max);
                });
        }

        // On load, create the websocket and set the onnopen, onmessage, and onclose callbacks.
        function load() {

            initSlider('sliderAlpha', [0, 1]);
            initSlider('sliderSize', [0, 20]);
            initSlider('sliderColormap', [0, 1]);


            window.websocket = new WebSocket("ws://localhost:1234/");
            window.websocket.binaryType = "arraybuffer";

            window.websocket.onopen = function () {
                console.log('socket open');

                var contents = loadJSON();
                submit(contents);
            };

            window.websocket.onmessage = ({ data }) => {
                // display the received image
                if (data instanceof ArrayBuffer) {
                    console.log("received image");
                    show(data);
                }
            };

            window.websocket.onclose = function () {
                console.log('closing socket');
            };



            // // Create the session list.
            // for (uri in SESSIONS) {
            //     appendSession(uri);
            // }



            window.zoom = 1;
            window.shift = 0;

            const img = document.getElementById('img');

            img.onwheel = function (e) {
                e.preventDefault();
                let d = -e.deltaY / Math.abs(e.deltaY);
                let z = window.zoom;

                var rect = e.target.getBoundingClientRect();
                var x = e.clientX - rect.left; //x position within the element.
                var y = e.clientY - rect.top;  //y position within the element.

                let w = e.srcElement.width;
                console.log(e);

                window.zoom *= (1 + .5 * d);
                window.zoom = Math.max(1, window.zoom);

                let center = -1 + 2 * x / w;
                window.shift -= center * (1 / z - 1 / window.zoom);

                if (window.zoom != z)
                    updateMVP();
            }

            img.ondblclick = function (e) {
                reset();
            }



            // const markerSizeSlider = document.getElementById('markerSize');
            onSliderChange('sliderColormap', function (min, max) {
                var arr = new StructArray(1, [
                    ["cmap_range", "float32", 2],
                ]);
                arr.set(0, "cmap_range", [min, max]);

                const req = {
                    "version": "1.0",
                    "requests": [
                        {
                            "action": "upload",
                            "type": "dat",
                            "id": 12,
                            "content": {
                                "offset": 16,
                                "data": {
                                    "mode": "base64",
                                    "buffer": arr.b64()
                                }
                            }
                        },
                    ]
                };
                console.log(req);

                submit(req);
            });

        }

        // Select another session.
        function select(uri) {
            var contents = updateRequest(uri);
            submit(contents);
        }



        // Return a MVP structure for a given pan and zoom.
        function mvp(px, py, zx, zy) {
            // 3 matrices 4x4: model, view, proj, and finally time
            var arr = new StructArray(1, [
                ["model", "float32", 16],
                ["view", "float32", 16],
                ["proj", "float32", 16],
                ["time", "float32", 1],
            ]);

            arr.set(0, "model", [
                1, 0, 0, 0,
                0, 1, 0, 0,
                0, 0, 1, 0,
                0, 0, 0, 1]);
            arr.set(0, "view", [
                1, 0, 0, 0,
                0, 1, 0, 0,
                0, 0, 1, 0,
                px, py, -2, 1]);
            arr.set(0, "proj", [
                zx, 0, 0, 0,
                0, zy, 0, 0,
                0, 0, -0.1, 0,
                0, 0, 0, 1]);
            arr.set(0, "time", [0]);

            return arr;
        }

        // Return a MVP structure for a given pan and zoom.
        function getParams() {
            var arr = new StructArray(1, [
                ["alpha_range", "float32", 2],
                ["size_range", "float32", 2],
                ["cmap_range", "float32", 2],
                ["cmap_id", "uint32", 1],
            ]);

            arr.set(0, "alpha_range", [0, 1]);
            arr.set(0, "size_range", [1, 10]);
            arr.set(0, "cmap_range", [0, 1]);
            arr.set(0, "cmap_id", [0]);

            return arr.b64();
        }

        // Send the updated MVP struct to the server.
        function updateMVP() {
            arr = mvp(window.shift, 0, window.zoom, 1);

            const req = {
                "version": "1.0",
                "requests": [
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 10,
                        "content": {
                            "offset": 0,
                            "data": {
                                "mode": "base64",
                                "buffer": arr.b64()
                            }
                        }
                    },
                ]
            };

            submit(req);
        }

        // Reset the view.
        function reset() {
            window.zoom = 1;
            window.shift = 0;

            updateMVP();
        }


    </script>
</head>

<body onload="load();">


    <!-- .container is main centered wrapper -->
    <div class="container">
        <div class="row">
            <h1>IBL raster plots</h1>
        </div>
        <form>
            <div class="row">
                <div class="four columns" id="left">

                    <nav>
                        <ol>
                            <!-- Select session -->
                            <li>
                                <label for="selectSession">session</label>
                                <select id="selectSession" class="u-full-width">
                                    <option value="myeid">lab/mysubj/2020-01-01/001/</option>
                                </select>
                            </li>

                            <!-- Select color -->
                            <li>
                                <label for="selectColor">color</label>
                                <select id="selectColor" class="u-full-width">
                                    <option value="time">time</option>
                                    <option value="cluster">cluster</option>
                                </select>
                            </li>

                            <!-- Select alpha -->
                            <li>
                                <label for="selectAlpha">alpha</label>
                                <select id="selectAlpha" class="u-full-width">
                                    <option value="time">time</option>
                                    <option value="cluster">cluster</option>
                                </select>
                            </li>

                            <!-- Select size -->
                            <li>
                                <label for="selectSize">size</label>
                                <select id="selectSize" class="u-full-width">
                                    <option value="time">time</option>
                                    <option value="cluster">cluster</option>
                                </select>
                            </li>
                        </ol>



                        <ol>
                            <!-- Select colormap -->
                            <li>
                                <label for="selectColormap">colormap</label>
                                <select id="selectColormap" class="u-full-width">
                                    <option value="hsv">hsv</option>
                                </select>
                            </li>

                            <!-- Select colormap range -->
                            <li>
                                <label for="sliderColormap">colormap range</label>
                                <div id="sliderColormap"></div>
                            </li>

                            <!-- Select alpha range -->
                            <li>
                                <label for="sliderAlpha">alpha</label>
                                <div id="sliderAlpha"></div>
                            </li>

                            <!-- Select size range -->
                            <li>
                                <label for="sliderSize">size</label>
                                <div id="sliderSize"></div>
                            </li>
                        </ol>

                    </nav>

                </div>
                <div class="eight columns" id="right">

                    <div>
                        <img id="img" />
                    </div>

                </div>
            </div>
        </form>
    </div>

</body>

</html>
