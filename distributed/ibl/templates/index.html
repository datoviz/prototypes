<!DOCTYPE html>
<html>

<head>
    <title>IBL raster plots</title>

    <!-- Raleway font -->
    <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>

    <!-- Normalize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
        integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Skeleton -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css"
        integrity="sha512-EZLkOqwILORob+p0BXZc+Vm3RgJBOe1Iq/0fiI7r/wJgzOFZMlsqTa29UEl6v6U6gsV4uIpsNZoV32YZqrCRCQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- noUIslider -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.min.js"
        integrity="sha512-T5Bneq9hePRO8JR0S/0lQ7gdW+ceLThvC80UjwkMRz+8q+4DARVZ4dqKoyENC7FcYresjfJ6ubaOgIE35irf4w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.min.css"
        integrity="sha512-qveKnGrvOChbSzAdtSs8p69eoLegyh+1hwOMbmpCViIwj7rn4oJjdmMvWOuyQlTOZgTlZA0N2PXA7iA8/2TUYA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"
        integrity="sha512-igVQ7hyQVijOUlfg3OmcTZLwYJIBXU63xL9RC12xBHNpmGJAktDnzl9Iw0J4yrSaQtDxTTVlwhY730vphoVqJQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"
        integrity="sha512-MgkNs0gNdrnOM7k+0L+wgiRc5aLgl74sJQKbIWegVIMvVGPc1+gc1L2oK9Wf/D9pq58eqIJAxOonYPVE5UwUFA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Custom CSS styles -->
    <style>
        #left {
            padding: 20px;
            background-color: #ddd;
        }

        #left ol {
            list-style-type: none;
        }

        #left li label {
            padding-left: 10px;
            font-weight: bold;
        }

        #left ol:first-child {
            padding-bottom: 16px;
            border-bottom: 1px solid #888;
        }

        #left ol select {
            background-color: #eaeaea;
        }



        #right img {
            width: 100%;
            aspect-ratio: 8/6;
            border: 1px solid #aaa;
        }


        /* Slider */

        .noUi-target {
            margin: 0 20px 30px 10px;
        }

        .noUi-base,
        .noUi-target {
            height: 10px !important;
        }

        .noUi-handle {
            width: 24px !important;
            height: 18px !important;
        }

        .noUi-tooltip {
            font-size: 14px;
            opacity: 0.75;
            display: none;
        }

        .noUi-active .noUi-tooltip {
            display: block;
        }

        .noUi-connect {
            background-color: #666
        }

        .noUi-handle::before,
        .noUi-handle:after {
            height: 5px !important;
        }

        .noUi-handle:before {
            left: 10px !important;
        }

        .noUi-handle:after {
            left: 12px !important;
        }
    </style>

    <!-- Array class -->
    <script>
        _DTYPE_MAPPING = {
            "uint8": [Uint8Array, 1],

            "uint16": [Uint16Array, 2],
            "int16": [Int16Array, 2],

            "uint32": [Uint32Array, 4],
            "int32": [Int32Array, 4],

            "float32": [Float32Array, 4],
            "float64": [Float64Array, 8],
        };

        function tob64(buffer) {
            var binary = '';
            var bytes = new Uint8Array(buffer);
            var len = bytes.byteLength;
            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        function StructArray(count, dtype) {
            this.count = count;
            this.dtype = dtype;
            this.fields = {};
            this.itemsize = 0;
            for (let i = 0; i < dtype.length; i++) {

                let name = dtype[i][0];
                let dt = dtype[i][1];
                let count = dtype[i][2];
                let size = _DTYPE_MAPPING[dt][1];

                this.fields[name] = {
                    type: dt,
                    count: count,
                    itemsize: size,
                    offset: this.itemsize
                };
                this.itemsize += count * size;
            }
            this.buffer = new ArrayBuffer(count * this.itemsize);
        };

        StructArray.prototype.set = function (idx, name, values) {
            let field = this.fields[name];
            let vt = _DTYPE_MAPPING[field.type][0];
            let view = new vt(this.buffer, this.itemsize * idx + field.offset, field.count);
            for (let i = 0; i < field.count; i++) {
                view[i] = values[i];
            }
        };

        StructArray.prototype.b64 = function () {
            return tob64(this.buffer);
        }

        function throttle(func, wait, options) {
            var context, args, result;
            var timeout = null;
            var previous = 0;
            if (!options) options = {};
            var later = function () {
                previous = options.leading === false ? 0 : Date.now();
                timeout = null;
                result = func.apply(context, args);
                if (!timeout) context = args = null;
            };
            return function () {
                var now = Date.now();
                if (!previous && options.leading === false) previous = now;
                var remaining = wait - (now - previous);
                context = this;
                args = arguments;
                if (remaining <= 0 || remaining > wait) {
                    if (timeout) {
                        clearTimeout(timeout);
                        timeout = null;
                    }
                    previous = now;
                    result = func.apply(context, args);
                    if (!timeout) context = args = null;
                } else if (!timeout && options.trailing !== false) {
                    timeout = setTimeout(later, remaining);
                }
                return result;
            };
        };

    </script>

    <!-- Visualization client -->
    <script>
        const COUNT = 2000000; // max number of spikes
        const DEFAULT_EID = "0851db85-2889-4070-ac18-a40e8ebd96ba";

        // Data payload for a given session.
        function sessionJSON(eid) {
            return {
                "eid": eid,
            };
        }

        // Load the initial JSON.
        function loadJSON() {
            var count = COUNT;
            return {
                "version": "1.0",
                "requests": [
                    {
                        "action": "create",
                        "type": "board",
                        "id": 1,
                        "content": {
                            "width": 800,
                            "height": 600,
                            "background": [255, 255, 255]
                        }
                    },
                    {
                        "action": "create",
                        "type": "graphics",
                        "id": 2,
                        "flags": 0,
                        "content": {
                            "board": 1,
                            "type": 7
                        }
                    },


                    // MVP: 10
                    {
                        "action": "create",
                        "type": "dat",
                        "id": 10,
                        "content": {
                            "type": 5,
                            "size": 200
                        }
                    },
                    {
                        "action": "bind",
                        "type": "dat",
                        "id": 2,
                        "content": {
                            "dat": 10,
                            "slot_idx": 0,
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 10,
                        "content": {
                            "offset": 0,
                            "size": 200,
                            "data": {
                                "mode": "base64",
                                "buffer": "AACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAAAAAACAPwAAgD8AAAAAAAAAAAAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAAAAgD8AAIA/AAAAAAAAAAAAAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAA=="
                            }
                        }
                    },


                    // Viewport: 11
                    {
                        "action": "create",
                        "type": "dat",
                        "id": 11,
                        "content": {
                            "type": 5,
                            "size": 80
                        }
                    },
                    {
                        "action": "bind",
                        "type": "dat",
                        "id": 2,
                        "content": {
                            "dat": 11,
                            "slot_idx": 1,
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 11,
                        "content": {
                            "offset": 0,
                            "size": 80,
                            "data": {
                                "mode": "base64",
                                "buffer": "AAAAAAAAAAAAAEhEAAAWRAAAAAAAAIA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAwAAWAIAAAAAAAAAAAAAIAMAAFgCAAAAAAAAAAAAAAAAAAAAAAAA"
                            }
                        }
                    },


                    // Params: 12
                    {
                        "action": "create",
                        "type": "dat",
                        "id": 12,
                        "content": {
                            "type": 5,
                            "size": 20
                        }
                    },
                    {
                        "action": "bind",
                        "type": "dat",
                        "id": 2,
                        "content": {
                            "dat": 12,
                            "slot_idx": 2,
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 12,
                        "content": {
                            "offset": 0,
                            "size": 20,
                            "data": {
                                "mode": "base64",
                                "buffer": getParams()
                            }
                        }
                    },


                    // Vertex buffer: 3
                    {
                        "action": "create",
                        "type": "dat",
                        "id": 3,
                        "content": {
                            "type": 2,
                            "size": 20 * count
                        }
                    },
                    {
                        "action": "set",
                        "type": "vertex",
                        "id": 2,
                        "content": {
                            "dat": 3
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 3,
                        "content": {
                            "offset": 0,
                            "data": {
                                "mode": "ibl_ephys",
                                "count": count,
                                "session": sessionJSON(DEFAULT_EID)
                            }
                        }
                    },



                    {
                        "action": "record",
                        "type": "begin",
                        "id": 1
                    },
                    {
                        "action": "record",
                        "type": "viewport",
                        "id": 1,
                        "content": {
                            "offset": [
                                0,
                                0
                            ],
                            "shape": [
                                0,
                                0
                            ]
                        }
                    },
                    {
                        "action": "record",
                        "type": "draw",
                        "id": 1,
                        "content": {
                            "graphics": 2,
                            "first_vertex": 0,
                            "vertex_count": count
                        }
                    },
                    {
                        "action": "record",
                        "type": "end",
                        "id": 1
                    }
                ]
            };
        }

        // Generate a JSON request to update to a new EID.
        function updateRequest(eid) {
            const req = {
                "version": "1.0",
                "requests": [
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 3,
                        "content": {
                            "offset": 0,
                            "data": {
                                "mode": "ibl_ephys",
                                "count": COUNT,
                                "session": sessionJSON(eid)
                            }
                        }
                    },
                ]
            };

            return req;
        }

        // Send requests to the server.
        function submit(contents) {
            if (!window.websocket) return;
            // if (window.websocket.readyState != 1) return;
            if (!window.websocket.connected) return;
            window.websocket.emit("request", contents);
        }

        submit = throttle(submit, 100);

        // Display an array buffer.
        function show(arrbuf) {
            const blob = new Blob([arrbuf]);
            const url = URL.createObjectURL(blob);
            const img = document.getElementById('img');
            img.src = url;
        }

        function initSlider(id, initRange, fullRange) {
            noUiSlider.create(document.getElementById(id), {
                start: initRange,
                connect: true,
                range: {
                    'min': fullRange[0],
                    'max': fullRange[1]
                },
                tooltips: true,
            });
        };

        function onSliderChange(id, callback) {
            document.getElementById(id).noUiSlider.on('update',
                function (values, handle, unencoded, tap, positions, noUiSlider) {
                    min = parseFloat(values[0]);
                    max = parseFloat(values[1]);
                    callback(min, max);
                });
        }

        function scaleSize(x) {
            return Math.log(1 + x);
        }

        // On load, create the websocket and set the onnopen, onmessage, and onclose callbacks.
        function load() {

            initSlider('sliderAlpha', [0, 1], [0, 1]);
            initSlider('sliderSize', [0.01, 1], [0, 5]);
            initSlider('sliderColormap', [0, 1], [0, 1]);


            window.websocket = io();

            // window.websocket = new WebSocket("ws://localhost:5000/");
            // window.websocket.binaryType = "arraybuffer";

            // window.websocket.onopen = function () {
            window.websocket.on("connect", () => {
                console.log('socket connected');

                var contents = loadJSON();
                submit(contents);
            });

            // window.websocket.onmessage = ({ data }) => {
            window.websocket.on("image", (data) => {
                // display the received image
                let img = data["image"];
                if (img instanceof ArrayBuffer) {
                    show(img);
                }
            });

            // window.websocket.onclose = function () {
            window.websocket.on("disconnect", () => {
                console.log('socket disconnected');
            });




            window.zoom = 1;
            window.shift = 0;

            const img = document.getElementById('img');

            img.onwheel = function (e) {
                e.preventDefault();
                let d = -e.deltaY / Math.abs(e.deltaY);
                let z = window.zoom;

                var rect = e.target.getBoundingClientRect();
                var x = e.clientX - rect.left; //x position within the element.
                var y = e.clientY - rect.top;  //y position within the element.

                let w = e.srcElement.width;

                window.zoom *= (1 + .5 * d);
                window.zoom = Math.max(1, window.zoom);

                let center = -1 + 2 * x / w;
                window.shift -= center * (1 / z - 1 / window.zoom);

                if (window.zoom != z)
                    updateMVP();
            }

            img.ondblclick = function (e) {
                reset();
            }



            onSliderChange('sliderColormap', function (min, max) {
                var arr = new StructArray(1, [
                    ["cmap_range", "float32", 2],
                ]);
                arr.set(0, "cmap_range", [min, max]);

                const req = {
                    "version": "1.0",
                    "requests": [
                        {
                            "action": "upload",
                            "type": "dat",
                            "id": 12,
                            "content": {
                                "offset": 16,
                                "data": {
                                    "mode": "base64",
                                    "buffer": arr.b64()
                                }
                            }
                        },
                    ]
                };

                submit(req);
            });

            onSliderChange('sliderSize', function (min, max) {
                var arr = new StructArray(1, [
                    ["size_range", "float32", 2],
                ]);
                window.sizeMin = min;
                window.sizeMax = max;
                arr.set(0, "size_range", [min, max * scaleSize(window.zoom)]);

                const req = {
                    "version": "1.0",
                    "requests": [
                        {
                            "action": "upload",
                            "type": "dat",
                            "id": 12,
                            "content": {
                                "offset": 8,
                                "data": {
                                    "mode": "base64",
                                    "buffer": arr.b64()
                                }
                            }
                        },
                    ]
                };

                submit(req);
            });

            onSliderChange('sliderAlpha', function (min, max) {
                var arr = new StructArray(1, [
                    ["alpha_range", "float32", 2],
                ]);
                arr.set(0, "alpha_range", [min, max]);

                const req = {
                    "version": "1.0",
                    "requests": [
                        {
                            "action": "upload",
                            "type": "dat",
                            "id": 12,
                            "content": {
                                "offset": 0,
                                "data": {
                                    "mode": "base64",
                                    "buffer": arr.b64()
                                }
                            }
                        },
                    ]
                };

                submit(req);
            });


            document.getElementById('selectSession').onchange = function (e) {
                select(e.target.value);
            }

            document.getElementById('selectColormap').onchange = function (e) {
                var cmap_id = parseInt(e.target.value);

                var arr = new StructArray(1, [
                    ["cmap_id", "uint32", 1],
                ]);
                arr.set(0, "cmap_id", [cmap_id]);

                const req = {
                    "version": "1.0",
                    "requests": [
                        {
                            "action": "upload",
                            "type": "dat",
                            "id": 12,
                            "content": {
                                "offset": 24,
                                "data": {
                                    "mode": "base64",
                                    "buffer": arr.b64()
                                }
                            }
                        },
                    ]
                };

                submit(req);
            }

            document.getElementById('selectColor').onchange = function (e) {
                var feature = e.target.value;

                const req = {
                    "version": "1.0",
                    "requests": [
                        {
                            "action": "upload",
                            "type": "dat",
                            "id": 3,
                            "content": {
                                "offset": 0,
                                "data": {
                                    "mode": "ibl_ephys",
                                    "count": COUNT,
                                    "session": sessionJSON(DEFAULT_EID),
                                    "features": {
                                        "color": feature
                                    }
                                }
                            }
                        },
                    ]
                };

                submit(req);


            }

        }

        // Select another session.
        function select(eid) {
            var contents = updateRequest(eid);
            submit(contents);
        }

        window.sizeMin = 0.01;
        window.sizeMax = 1;


        // Return a MVP structure for a given pan and zoom.
        function mvp(px, py, zx, zy) {
            // 3 matrices 4x4: model, view, proj, and finally time
            var arr = new StructArray(1, [
                ["model", "float32", 16],
                ["view", "float32", 16],
                ["proj", "float32", 16],
                ["time", "float32", 1],
            ]);

            arr.set(0, "model", [
                1, 0, 0, 0,
                0, 1, 0, 0,
                0, 0, 1, 0,
                0, 0, 0, 1]);
            arr.set(0, "view", [
                1, 0, 0, 0,
                0, 1, 0, 0,
                0, 0, 1, 0,
                px, py, -2, 1]);
            arr.set(0, "proj", [
                zx, 0, 0, 0,
                0, zy, 0, 0,
                0, 0, -0.1, 0,
                0, 0, 0, 1]);
            arr.set(0, "time", [0]);

            return arr;
        }

        // Return a MVP structure for a given pan and zoom.
        function getParams() {
            var arr = new StructArray(1, [
                ["alpha_range", "float32", 2],
                ["size_range", "float32", 2],
                ["cmap_range", "float32", 2],
                ["cmap_id", "uint32", 1],
            ]);

            arr.set(0, "alpha_range", [0, 1]);
            arr.set(0, "size_range", [.01, 1]);
            arr.set(0, "cmap_range", [0, 1]);
            arr.set(0, "cmap_id", [0]);

            return arr.b64();
        }

        // Send the updated MVP struct to the server.
        function updateMVP() {
            arr = mvp(window.shift, 0, window.zoom, 1);


            var arrs = new StructArray(1, [
                ["size_range", "float32", 2],
            ]);
            arrs.set(0, "size_range", [window.sizeMin, window.sizeMax * scaleSize(window.zoom)]);

            const req = {
                "version": "1.0",
                "requests": [
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 10,
                        "content": {
                            "offset": 0,
                            "data": {
                                "mode": "base64",
                                "buffer": arr.b64()
                            }
                        }
                    },
                    {
                        "action": "upload",
                        "type": "dat",
                        "id": 12,
                        "content": {
                            "offset": 8,
                            "data": {
                                "mode": "base64",
                                "buffer": arrs.b64()
                            }
                        }
                    },
                ]
            };

            submit(req);
        }

        // Reset the view.
        function reset() {
            window.zoom = 1;
            window.shift = 0;

            updateMVP();
        }


    </script>
</head>

<body onload="load();">


    <!-- .container is main centered wrapper -->
    <div class="container">
        <div class="row">
            <h1>IBL raster plots</h1>
        </div>
        <form>
            <div class="row">
                <div class="four columns" id="left">
                    <nav>
                        <ol>
                            <!-- Select session -->
                            <li>
                                <label for="selectSession">session</label>
                                <select id="selectSession" class="u-full-width">
                                    {% for session in sessions %}
                                    <option value="{{ session }}">{{ session }}</option>
                                    {% endfor %}
                                </select>
                            </li>

                            <!-- Select color -->
                            <li>
                                <label for="selectColor">color</label>
                                <select id="selectColor" class="u-full-width">
                                    <option value="time">time</option>
                                    <option value="cluster">cluster</option>
                                    <option value="amplitude">amplitude</option>
                                    <option value="depth">depth</option>
                                </select>
                            </li>

                            <!-- Select alpha -->
                            <li>
                                <label for="selectAlpha">alpha</label>
                                <select id="selectAlpha" class="u-full-width">
                                    <option value="time">time</option>
                                    <option value="cluster">cluster</option>
                                </select>
                            </li>

                            <!-- Select size -->
                            <li>
                                <label for="selectSize">size</label>
                                <select id="selectSize" class="u-full-width">
                                    <option value="time">time</option>
                                    <option value="cluster">cluster</option>
                                </select>
                            </li>
                        </ol>



                        <ol>
                            <!-- Select colormap -->
                            <li>
                                <label for="selectColormap">colormap</label>
                                <select id="selectColormap" class="u-full-width">
                                    <option value="0">binary</option>
                                    <option value="1">hsv</option>
                                    <option value="6">viridis</option>
                                    <option value="27">cool</option>
                                    <option value="31">hot</option>
                                    <option value="61">jet</option>
                                </select>
                            </li>

                            <!-- Select colormap range -->
                            <li>
                                <label for="sliderColormap">colormap range</label>
                                <div id="sliderColormap"></div>
                            </li>

                            <!-- Select alpha range -->
                            <li>
                                <label for="sliderAlpha">alpha range</label>
                                <div id="sliderAlpha"></div>
                            </li>

                            <!-- Select size range -->
                            <li>
                                <label for="sliderSize">size range</label>
                                <div id="sliderSize"></div>
                            </li>
                        </ol>

                    </nav>

                </div>
                <div class="eight columns" id="right">

                    <div>
                        <img id="img" />
                    </div>

                </div>
            </div>
        </form>
    </div>

</body>

</html>
